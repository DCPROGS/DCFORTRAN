	program tdf1
c To test fit with dfpmin for SCAN
c method=0 is DC method for derivatives in dsfunc1
c method=1 is direct method by evaluating SFUNC at 2 param values
	real*4 data(2048),theta(50),theta0(5)
	real*4 gval(50)	!for speed test
	real*4 stepamp(50)
	real*4 ydcalc(2048)	!calc values from SCANFUNC (in common/ycal/)
	integer jfix(50)
	real*4 filt1(1024)
	common/fitblk/data,if1,if2,ntrans,neval,nevfix,itype,stepamp,y0
	common/ycal/ydcalc	!calc values from SCANFUNC
	common/km/kmax		!for dsfunc
	common/filtblk/filt1,nfilt1,dtf1,npfilt,finter
	external sfunc1,dsfunc1
	common/min/method
c
	finter=100.
	if1=1
	if2=122
	ntrans=2
	kmax=5
	do i=1,50
	   jfix(i)=0
	enddo
c
c Data
	DATA(1)=153.000
	DATA(2)=-53.0000
	DATA(3)=-41.0000
	DATA(4)=83.0000
	DATA(5)=173.000
	DATA(6)=93.0000
	DATA(7)=-35.0000
	DATA(8)=179.000
	DATA(9)=241.000
	DATA(10)=196.000
	DATA(11)=303.000
	DATA(12)=213.000
	DATA(13)=49.0000
	DATA(14)=110.000
	DATA(15)=152.000
	DATA(16)=241.000
	DATA(17)=200.000
	DATA(18)=121.000
	DATA(19)=83.0000
	DATA(20)=196.000
	DATA(21)=313.000
	DATA(22)=223.000
	DATA(23)=227.000
	DATA(24)=233.000
	DATA(25)=66.0000
	DATA(26)=43.0000
	DATA(27)=151.000
	DATA(28)=202.000
	DATA(29)=251.000
	DATA(30)=280.000
	DATA(31)=316.000
	DATA(32)=171.000
	DATA(33)=254.000
	DATA(34)=219.000
	DATA(35)=62.0000
	DATA(36)=41.0000
	DATA(37)=155.000
	DATA(38)=188.000
	DATA(39)=229.000
	DATA(40)=236.000
	DATA(41)=66.0000
	DATA(42)=-46.0000
	DATA(43)=-72.0000
	DATA(44)=205.000
	DATA(45)=268.000
	DATA(46)=202.000
	DATA(47)=178.000
	DATA(48)=131.000
	DATA(49)=113.000
	DATA(50)=175.000
	DATA(51)=222.000
	DATA(52)=233.000
	DATA(53)=224.000
	DATA(54)=195.000
	DATA(55)=50.0000
	DATA(56)=71.0000
	DATA(57)=76.0000
	DATA(58)=-32.0000
	DATA(59)=112.000
	DATA(60)=162.000
	DATA(61)=126.000
	DATA(62)=143.000
	DATA(63)=161.000
	DATA(64)=200.000
	DATA(65)=88.0000
	DATA(66)=157.000
	DATA(67)=153.000
	DATA(68)=191.000
	DATA(69)=257.000
	DATA(70)=92.0000
	DATA(71)=-21.0000
	DATA(72)=138.000
	DATA(73)=111.000
	DATA(74)=-45.0000
	DATA(75)=104.000
	DATA(76)=110.000
	DATA(77)=90.0000
	DATA(78)=45.0000
	DATA(79)=161.000
	DATA(80)=164.000
	DATA(81)=53.0000
	DATA(82)=137.000
	DATA(83)=-238.000
	DATA(84)=-1078.00
	DATA(85)=-1365.00
	DATA(86)=-1319.00
	DATA(87)=-1470.00
	DATA(88)=-1373.00
	DATA(89)=-1333.00
	DATA(90)=-1124.00
	DATA(91)=-1198.00
	DATA(92)=-1414.00
	DATA(93)=-1311.00
	DATA(94)=-1306.00
	DATA(95)=-1151.00
	DATA(96)=-1250.00
	DATA(97)=-1370.00
	DATA(98)=-1259.00
	DATA(99)=-1189.00
	DATA(100)=-1118.00
	DATA(101)=-1150.00
	DATA(102)=-1159.00
	DATA(103)=-1265.00
	DATA(104)=-959.000
	DATA(105)=-121.000
	DATA(106)=195.000
	DATA(107)=166.000
	DATA(108)=244.000
	DATA(109)=193.000
	DATA(110)=117.000
	DATA(111)=318.000
	DATA(112)=246.000
	DATA(113)=155.000
	DATA(114)=217.000
	DATA(115)=263.000
	DATA(116)=258.000
	DATA(117)=228.000
	DATA(118)=206.000
	DATA(119)=122.000
	DATA(120)=195.000
	DATA(121)=238.000
	DATA(122)=153.000
c
c Filter
	nfilt1=412
	npfilt=2
	dtf1=1.0
	FILT1(1)=0.108659E-03
	FILT1(2)=0.103803E-02
	FILT1(3)=0.109186E-02
	FILT1(4)=0.114825E-02
	FILT1(5)=0.120730E-02
	FILT1(6)=0.126910E-02
	FILT1(7)=0.133378E-02
	FILT1(8)=0.140146E-02
	FILT1(9)=0.147226E-02
	FILT1(10)=0.154631E-02
	FILT1(11)=0.162375E-02
	FILT1(12)=0.170470E-02
	FILT1(13)=0.178932E-02
	FILT1(14)=0.187774E-02
	FILT1(15)=0.197012E-02
	FILT1(16)=0.206661E-02
	FILT1(17)=0.216736E-02
	FILT1(18)=0.227254E-02
	FILT1(19)=0.238232E-02
	FILT1(20)=0.249689E-02
	FILT1(21)=0.261641E-02
	FILT1(22)=0.274106E-02
	FILT1(23)=0.287105E-02
	FILT1(24)=0.300657E-02
	FILT1(25)=0.314784E-02
	FILT1(26)=0.329506E-02
	FILT1(27)=0.344844E-02
	FILT1(28)=0.360821E-02
	FILT1(29)=0.377460E-02
	FILT1(30)=0.394783E-02
	FILT1(31)=0.412816E-02
	FILT1(32)=0.431580E-02
	FILT1(33)=0.451103E-02
	FILT1(34)=0.471411E-02
	FILT1(35)=0.492531E-02
	FILT1(36)=0.514489E-02
	FILT1(37)=0.537313E-02
	FILT1(38)=0.561033E-02
	FILT1(39)=0.585679E-02
	FILT1(40)=0.611281E-02
	FILT1(41)=0.637871E-02
	FILT1(42)=0.665479E-02
	FILT1(43)=0.694139E-02
	FILT1(44)=0.723884E-02
	FILT1(45)=0.754747E-02
	FILT1(46)=0.786763E-02
	FILT1(47)=0.819966E-02
	FILT1(48)=0.854393E-02
	FILT1(49)=0.890082E-02
	FILT1(50)=0.927071E-02
	FILT1(51)=0.965399E-02
	FILT1(52)=0.100510E-01
	FILT1(53)=0.104622E-01
	FILT1(54)=0.108881E-01
	FILT1(55)=0.113289E-01
	FILT1(56)=0.117851E-01
	FILT1(57)=0.122573E-01
	FILT1(58)=0.127457E-01
	FILT1(59)=0.132508E-01
	FILT1(60)=0.137732E-01
	FILT1(61)=0.143132E-01
	FILT1(62)=0.148714E-01
	FILT1(63)=0.154482E-01
	FILT1(64)=0.160440E-01
	FILT1(65)=0.166595E-01
	FILT1(66)=0.172951E-01
	FILT1(67)=0.179512E-01
	FILT1(68)=0.186285E-01
	FILT1(69)=0.193274E-01
	FILT1(70)=0.200484E-01
	FILT1(71)=0.207922E-01
	FILT1(72)=0.215592E-01
	FILT1(73)=0.223499E-01
	FILT1(74)=0.231650E-01
	FILT1(75)=0.240049E-01
	FILT1(76)=0.248703E-01
	FILT1(77)=0.257617E-01
	FILT1(78)=0.266797E-01
	FILT1(79)=0.276249E-01
	FILT1(80)=0.285978E-01
	FILT1(81)=0.295991E-01
	FILT1(82)=0.306292E-01
	FILT1(83)=0.316889E-01
	FILT1(84)=0.327787E-01
	FILT1(85)=0.338993E-01
	FILT1(86)=0.350511E-01
	FILT1(87)=0.362349E-01
	FILT1(88)=0.374511E-01
	FILT1(89)=0.387006E-01
	FILT1(90)=0.399837E-01
	FILT1(91)=0.413013E-01
	FILT1(92)=0.426538E-01
	FILT1(93)=0.440419E-01
	FILT1(94)=0.454662E-01
	FILT1(95)=0.469273E-01
	FILT1(96)=0.484258E-01
	FILT1(97)=0.499624E-01
	FILT1(98)=0.515376E-01
	FILT1(99)=0.531520E-01
	FILT1(100)=0.548063E-01
	FILT1(101)=0.565010E-01
	FILT1(102)=0.582367E-01
	FILT1(103)=0.600140E-01
	FILT1(104)=0.618336E-01
	FILT1(105)=0.636959E-01
	FILT1(106)=0.656015E-01
	FILT1(107)=0.675511E-01
	FILT1(108)=0.695451E-01
	FILT1(109)=0.715842E-01
	FILT1(110)=0.736688E-01
	FILT1(111)=0.757995E-01
	FILT1(112)=0.779769E-01
	FILT1(113)=0.802014E-01
	FILT1(114)=0.824735E-01
	FILT1(115)=0.847937E-01
	FILT1(116)=0.871625E-01
	FILT1(117)=0.895804E-01
	FILT1(118)=0.920478E-01
	FILT1(119)=0.945652E-01
	FILT1(120)=0.971330E-01
	FILT1(121)=0.997515E-01
	FILT1(122)=0.102421
	FILT1(123)=0.105143
	FILT1(124)=0.107916
	FILT1(125)=0.110742
	FILT1(126)=0.113620
	FILT1(127)=0.116551
	FILT1(128)=0.119535
	FILT1(129)=0.122573
	FILT1(130)=0.125665
	FILT1(131)=0.128811
	FILT1(132)=0.132011
	FILT1(133)=0.135265
	FILT1(134)=0.138574
	FILT1(135)=0.141937
	FILT1(136)=0.145356
	FILT1(137)=0.148829
	FILT1(138)=0.152358
	FILT1(139)=0.155941
	FILT1(140)=0.159580
	FILT1(141)=0.163273
	FILT1(142)=0.167022
	FILT1(143)=0.170826
	FILT1(144)=0.174685
	FILT1(145)=0.178599
	FILT1(146)=0.182567
	FILT1(147)=0.186590
	FILT1(148)=0.190668
	FILT1(149)=0.194800
	FILT1(150)=0.198986
	FILT1(151)=0.203225
	FILT1(152)=0.207518
	FILT1(153)=0.211865
	FILT1(154)=0.216264
	FILT1(155)=0.220715
	FILT1(156)=0.225218
	FILT1(157)=0.229773
	FILT1(158)=0.234380
	FILT1(159)=0.239036
	FILT1(160)=0.243743
	FILT1(161)=0.248500
	FILT1(162)=0.253305
	FILT1(163)=0.258159
	FILT1(164)=0.263061
	FILT1(165)=0.268010
	FILT1(166)=0.273005
	FILT1(167)=0.278046
	FILT1(168)=0.283132
	FILT1(169)=0.288262
	FILT1(170)=0.293436
	FILT1(171)=0.298652
	FILT1(172)=0.303910
	FILT1(173)=0.309209
	FILT1(174)=0.314548
	FILT1(175)=0.319926
	FILT1(176)=0.325342
	FILT1(177)=0.330795
	FILT1(178)=0.336284
	FILT1(179)=0.341809
	FILT1(180)=0.347368
	FILT1(181)=0.352959
	FILT1(182)=0.358583
	FILT1(183)=0.364237
	FILT1(184)=0.369921
	FILT1(185)=0.375634
	FILT1(186)=0.381374
	FILT1(187)=0.387140
	FILT1(188)=0.392931
	FILT1(189)=0.398746
	FILT1(190)=0.404584
	FILT1(191)=0.410443
	FILT1(192)=0.416322
	FILT1(193)=0.422220
	FILT1(194)=0.428135
	FILT1(195)=0.434066
	FILT1(196)=0.440013
	FILT1(197)=0.445972
	FILT1(198)=0.451945
	FILT1(199)=0.457928
	FILT1(200)=0.463920
	FILT1(201)=0.469921
	FILT1(202)=0.475928
	FILT1(203)=0.481942
	FILT1(204)=0.487959
	FILT1(205)=0.493979
	FILT1(206)=0.500000
	FILT1(207)=0.506021
	FILT1(208)=0.512041
	FILT1(209)=0.518058
	FILT1(210)=0.524072
	FILT1(211)=0.530079
	FILT1(212)=0.536080
	FILT1(213)=0.542072
	FILT1(214)=0.548055
	FILT1(215)=0.554028
	FILT1(216)=0.559987
	FILT1(217)=0.565934
	FILT1(218)=0.571865
	FILT1(219)=0.577781
	FILT1(220)=0.583678
	FILT1(221)=0.589557
	FILT1(222)=0.595416
	FILT1(223)=0.601254
	FILT1(224)=0.607069
	FILT1(225)=0.612860
	FILT1(226)=0.618626
	FILT1(227)=0.624366
	FILT1(228)=0.630079
	FILT1(229)=0.635763
	FILT1(230)=0.641417
	FILT1(231)=0.647041
	FILT1(232)=0.652632
	FILT1(233)=0.658191
	FILT1(234)=0.663716
	FILT1(235)=0.669205
	FILT1(236)=0.674658
	FILT1(237)=0.680074
	FILT1(238)=0.685452
	FILT1(239)=0.690791
	FILT1(240)=0.696090
	FILT1(241)=0.701348
	FILT1(242)=0.706564
	FILT1(243)=0.711738
	FILT1(244)=0.716868
	FILT1(245)=0.721954
	FILT1(246)=0.726995
	FILT1(247)=0.731990
	FILT1(248)=0.736939
	FILT1(249)=0.741841
	FILT1(250)=0.746695
	FILT1(251)=0.751500
	FILT1(252)=0.756257
	FILT1(253)=0.760964
	FILT1(254)=0.765621
	FILT1(255)=0.770227
	FILT1(256)=0.774782
	FILT1(257)=0.779285
	FILT1(258)=0.783737
	FILT1(259)=0.788135
	FILT1(260)=0.792482
	FILT1(261)=0.796775
	FILT1(262)=0.801014
	FILT1(263)=0.805200
	FILT1(264)=0.809332
	FILT1(265)=0.813410
	FILT1(266)=0.817433
	FILT1(267)=0.821401
	FILT1(268)=0.825315
	FILT1(269)=0.829174
	FILT1(270)=0.832978
	FILT1(271)=0.836727
	FILT1(272)=0.840420
	FILT1(273)=0.844059
	FILT1(274)=0.847643
	FILT1(275)=0.851171
	FILT1(276)=0.854644
	FILT1(277)=0.858063
	FILT1(278)=0.861426
	FILT1(279)=0.864735
	FILT1(280)=0.867989
	FILT1(281)=0.871189
	FILT1(282)=0.874335
	FILT1(283)=0.877427
	FILT1(284)=0.880465
	FILT1(285)=0.883449
	FILT1(286)=0.886380
	FILT1(287)=0.889258
	FILT1(288)=0.892084
	FILT1(289)=0.894857
	FILT1(290)=0.897579
	FILT1(291)=0.900248
	FILT1(292)=0.902867
	FILT1(293)=0.905435
	FILT1(294)=0.907952
	FILT1(295)=0.910420
	FILT1(296)=0.912838
	FILT1(297)=0.915206
	FILT1(298)=0.917527
	FILT1(299)=0.919799
	FILT1(300)=0.922023
	FILT1(301)=0.924200
	FILT1(302)=0.926331
	FILT1(303)=0.928416
	FILT1(304)=0.930455
	FILT1(305)=0.932449
	FILT1(306)=0.934399
	FILT1(307)=0.936304
	FILT1(308)=0.938167
	FILT1(309)=0.939986
	FILT1(310)=0.941763
	FILT1(311)=0.943499
	FILT1(312)=0.945194
	FILT1(313)=0.946848
	FILT1(314)=0.948462
	FILT1(315)=0.950038
	FILT1(316)=0.951574
	FILT1(317)=0.953073
	FILT1(318)=0.954534
	FILT1(319)=0.955958
	FILT1(320)=0.957346
	FILT1(321)=0.958699
	FILT1(322)=0.960016
	FILT1(323)=0.961299
	FILT1(324)=0.962549
	FILT1(325)=0.963765
	FILT1(326)=0.964949
	FILT1(327)=0.966101
	FILT1(328)=0.967221
	FILT1(329)=0.968311
	FILT1(330)=0.969371
	FILT1(331)=0.970401
	FILT1(332)=0.971402
	FILT1(333)=0.972375
	FILT1(334)=0.973320
	FILT1(335)=0.974238
	FILT1(336)=0.975130
	FILT1(337)=0.975995
	FILT1(338)=0.976835
	FILT1(339)=0.977650
	FILT1(340)=0.978441
	FILT1(341)=0.979208
	FILT1(342)=0.979952
	FILT1(343)=0.980673
	FILT1(344)=0.981372
	FILT1(345)=0.982049
	FILT1(346)=0.982705
	FILT1(347)=0.983341
	FILT1(348)=0.983956
	FILT1(349)=0.984552
	FILT1(350)=0.985129
	FILT1(351)=0.985687
	FILT1(352)=0.986227
	FILT1(353)=0.986749
	FILT1(354)=0.987254
	FILT1(355)=0.987743
	FILT1(356)=0.988215
	FILT1(357)=0.988671
	FILT1(358)=0.989112
	FILT1(359)=0.989538
	FILT1(360)=0.989949
	FILT1(361)=0.990346
	FILT1(362)=0.990729
	FILT1(363)=0.991099
	FILT1(364)=0.991456
	FILT1(365)=0.991800
	FILT1(366)=0.992132
	FILT1(367)=0.992453
	FILT1(368)=0.992761
	FILT1(369)=0.993059
	FILT1(370)=0.993345
	FILT1(371)=0.993621
	FILT1(372)=0.993887
	FILT1(373)=0.994143
	FILT1(374)=0.994390
	FILT1(375)=0.994627
	FILT1(376)=0.994855
	FILT1(377)=0.995075
	FILT1(378)=0.995286
	FILT1(379)=0.995489
	FILT1(380)=0.995684
	FILT1(381)=0.995872
	FILT1(382)=0.996052
	FILT1(383)=0.996225
	FILT1(384)=0.996392
	FILT1(385)=0.996552
	FILT1(386)=0.996705
	FILT1(387)=0.996852
	FILT1(388)=0.996993
	FILT1(389)=0.997129
	FILT1(390)=0.997259
	FILT1(391)=0.997384
	FILT1(392)=0.997503
	FILT1(393)=0.997618
	FILT1(394)=0.997728
	FILT1(395)=0.997833
	FILT1(396)=0.997933
	FILT1(397)=0.998030
	FILT1(398)=0.998122
	FILT1(399)=0.998211
	FILT1(400)=0.998295
	FILT1(401)=0.998376
	FILT1(402)=0.998454
	FILT1(403)=0.998528
	FILT1(404)=0.998599
	FILT1(405)=0.998666
	FILT1(406)=0.998731
	FILT1(407)=0.998793
	FILT1(408)=0.998852
	FILT1(409)=0.998908
	FILT1(410)=0.998962
	FILT1(411)=0.999013
	FILT1(412)=1.00000
c
c Initial guess
	THETA(1)=7936.51
	THETA(2)=10019.9
	THETA(3)=142.256
	THETA(4)=-1269.68
	THETA(5)=157.892
c
	nt=kmax
	n=kmax
	gtol=1.e-4
	stpmx=1.0
	ndisp=1
	method=0
      call dfpmin1(theta,nt,gtol,iter,fret,sfunc1,dsfunc1,
     & stpmx,jfix,ndisp)
c Result found in SCAN was
	THETA0(1)=8031.12
	THETA0(2)=10146.0
	THETA0(3)=142.861
	THETA0(4)=-1272.90
	THETA0(5)=208.149
	print 1,(theta(i),i=1,5),(theta0(i),i=1,5)
1	format('    fitted = ',5g13.6,/,' ''correct'' = ',5g13.6)
c Test speed
c	method=0
c	call TIMER(n1)
c	do i=1,10000
c	   call DSFUNC1(theta,gval)
c	enddo
c	call TIMER(n2)
c	print 10,10*(n2-n1)
c10	format(' Method 0: ',i9,'ms')
c	method=1
c	call TIMER(n1)
c	do i=1,10000
c	   call DSFUNC1(theta,gval)
c	enddo
c	call TIMER(n2)
c	print 11,10*(n2-n1)
c11	format(' Method 1: ',i9,'ms')
	end
